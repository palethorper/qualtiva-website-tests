name: Qualtiva Website Playwright Tests

on:
  push:
  pull_request:
  schedule:
    # Run tests daily at 2 AM Sydney/Australia time (AEDT - UTC+11, winter AEST - UTC+10)
    # AEDT (Oct-Apr): 2am Sydney = 3pm UTC previous day
    # AEST (Apr-Oct): 2am Sydney = 4pm UTC previous day
    # Using 15:00 UTC for AEDT coverage (3pm = 2am next day Sydney)
    - cron: '0 15 * * *'

jobs:
  smoke:
    name: Smoke Tests (10 Quick Tests)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: '~/.cache/ms-playwright'
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: Run Smoke Tests (Chromium only)
      run: npm run test:smoke -- --project=chromium
      timeout-minutes: 10
      env:
        CI: true
        BASE_URL: https://www-dev.analytiqa.cloud/

    - name: Post results to AQA
      if: always()
      shell: pwsh
      env:
        AQA_USER: ${{ secrets.AQA_USER }}
        AQA_PASSWORD: ${{ secrets.AQA_PASSWORD }}
        AQA_ENDPOINT: ${{ vars.AQA_ENDPOINT }}
      run: >
        pwsh -File ./scripts/aqa-post-results.ps1
        -ResultsDir ./test-results
        -FileFilter "*results.xml"
        -ResultFormat junit
        -Engine playwright
        -Tags "smoke"
        -Team "web-developers"
        -Project "qualtiva-website-tests"
        -Application "qualtiva-website"
        -Product "qualtiva"
        -Environment "dev"

    - name: Upload Smoke HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-report
        path: playwright-report/
        retention-days: 5

    - name: Upload Smoke JUnit & JSON Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: test-results/
        retention-days: 5

  test:
    name: Qualtiva Solutions Website Tests
    runs-on: ubuntu-latest
    needs: smoke
    
    strategy:
      fail-fast: false
      matrix:
        # Test on latest Node.js version
        node-version: [20]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: '~/.cache/ms-playwright'
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run Playwright tests (Chromium only)
      run: npx playwright test --project=chromium
      timeout-minutes: 30
      env:
        # Add any environment variables needed for testing
        CI: true
        BASE_URL: https://www-dev.analytiqa.cloud/
        
    - name: Upload HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-node${{ matrix.node-version }}
        path: playwright-report/
        retention-days: 5
        
    - name: Upload JUnit & JSON Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-node${{ matrix.node-version }}
        path: test-results/
        retention-days: 5

 