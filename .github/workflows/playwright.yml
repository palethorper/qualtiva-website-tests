name: Qualtiva Website Playwright Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM Sydney/Australia time (AEDT - UTC+11, winter AEST - UTC+10)
    # AEDT (Oct-Apr): 2am Sydney = 3pm UTC previous day
    # AEST (Apr-Oct): 2am Sydney = 4pm UTC previous day
    # Using 15:00 UTC for AEDT coverage (3pm = 2am next day Sydney)
    - cron: '0 15 * * *'

jobs:
  test:
    name: Qualtiva Solutions Website Tests
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        # Test on latest Node.js version
        node-version: [20]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run Playwright tests
      run: |
        echo "Starting test execution..."
        npm run test:ci &
        TEST_PID=$!
        
        # Monitor test progress
        while kill -0 $TEST_PID 2>/dev/null; do
          echo "Tests are running... ($(date '+%H:%M:%S'))"
          sleep 30
        done
        
        wait $TEST_PID
        TEST_EXIT_CODE=$?
        echo "Tests completed with exit code: $TEST_EXIT_CODE"
        exit $TEST_EXIT_CODE
      env:
        # Add any environment variables needed for testing
        CI: true
        BASE_URL: https://www-dev.analytiqa.cloud/
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.node-version }}
        path: |
          playwright-report/
          test-results/
        retention-days: 30
        
    - name: Upload test results to GitHub
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-results-${{ matrix.node-version }}
        path: test-results/
        retention-days: 30

  test-mobile:
    name: Mobile Browser Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run mobile tests
      run: |
        echo "Starting mobile test execution..."
        npm run test:mobile &
        TEST_PID=$!
        
        while kill -0 $TEST_PID 2>/dev/null; do
          echo "Mobile tests running... ($(date '+%H:%M:%S'))"
          sleep 30
        done
        
        wait $TEST_PID
        TEST_EXIT_CODE=$?
        echo "Mobile tests completed with exit code: $TEST_EXIT_CODE"
        exit $TEST_EXIT_CODE
      env:
        CI: true
        BASE_URL: https://www-dev.analytiqa.cloud/
        
    - name: Upload mobile test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-test-results
        path: |
          playwright-report/
          test-results/
        retention-days: 30

  test-performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run performance tests
      run: |
        echo "Starting performance test execution..."
        npm run test:performance &
        TEST_PID=$!
        
        while kill -0 $TEST_PID 2>/dev/null; do
          echo "Performance tests running... ($(date '+%H:%M:%S'))"
          sleep 30
        done
        
        wait $TEST_PID
        TEST_EXIT_CODE=$?
        echo "Performance tests completed with exit code: $TEST_EXIT_CODE"
        exit $TEST_EXIT_CODE
      env:
        CI: true
        BASE_URL: https://www-dev.analytiqa.cloud/
        
    - name: Upload performance test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: |
          playwright-report/
          test-results/
        retention-days: 30

  test-accessibility:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run accessibility tests
      run: |
        echo "Starting accessibility test execution..."
        npm run test:accessibility &
        TEST_PID=$!
        
        while kill -0 $TEST_PID 2>/dev/null; do
          echo "Accessibility tests running... ($(date '+%H:%M:%S'))"
          sleep 30
        done
        
        wait $TEST_PID
        TEST_EXIT_CODE=$?
        echo "Accessibility tests completed with exit code: $TEST_EXIT_CODE"
        exit $TEST_EXIT_CODE
      env:
        CI: true
        BASE_URL: https://www-dev.analytiqa.cloud/
        
    - name: Upload accessibility test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: accessibility-test-results
        path: |
          playwright-report/
          test-results/
        retention-days: 30

  test-best-practices:
    name: Web Build Best Practices Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run best practices tests
      run: |
        echo "Starting best practices test execution..."
        npm run test:best-practices &
        TEST_PID=$!
        
        while kill -0 $TEST_PID 2>/dev/null; do
          echo "Best practices tests running... ($(date '+%H:%M:%S'))"
          sleep 30
        done
        
        wait $TEST_PID
        TEST_EXIT_CODE=$?
        echo "Best practices tests completed with exit code: $TEST_EXIT_CODE"
        exit $TEST_EXIT_CODE
      env:
        CI: true
        BASE_URL: https://www-dev.analytiqa.cloud/
        
    - name: Upload best practices test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: best-practices-test-results
        path: |
          playwright-report/
          test-results/
        retention-days: 30

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, test-mobile, test-performance, test-accessibility, test-best-practices]
    if: failure()
    
    steps:
    - name: Notify on test failure
      run: |
        echo "One or more test jobs failed. Check the GitHub Actions logs for details."
        echo "Failed jobs:"
        echo "- test: ${{ needs.test.result }}"
        echo "- test-mobile: ${{ needs.test-mobile.result }}"
        echo "- test-performance: ${{ needs.test-performance.result }}"
        echo "- test-accessibility: ${{ needs.test-accessibility.result }}"
        echo "- test-best-practices: ${{ needs.test-best-practices.result }}" 