name: Smoke Tests - Quick Validation

on:
  workflow_dispatch:

jobs:
  smoke-test:
    name: Smoke Tests (10 Quick Tests)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: '~/.cache/ms-playwright'
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium
      
    - name: Run Smoke Tests (Chromium only)
      run: npm run test:smoke -- --project=chromium
      timeout-minutes: 10
      env:
        CI: true
        BASE_URL: https://www-dev.analytiqa.cloud/

    - name: Post results to AQA
      if: always()
      shell: pwsh
      env:
        AQA_USER: ${{ secrets.AQA_USER }}
        AQA_PASSWORD: ${{ secrets.AQA_PASSWORD }}
        AQA_ENDPOINT: ${{ vars.AQA_ENDPOINT }}
      run: >
        pwsh -File ./scripts/aqa-post-results.ps1
        -ResultsDir ./test-results
        -FileFilter "*results.xml"
        -ResultFormat junit
        -Engine playwright
        -Tags "smoke"
        -Team "web-developers"
        -Project "qualtiva-website-tests"
        -Application "qualtiva-website"
        -Product "qualtiva"
        -Environment "dev"
        
    - name: Upload HTML Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-report
        path: playwright-report/
        retention-days: 5
        
    - name: Upload JUnit & JSON Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: test-results/
        retention-days: 5
